---
phase: 06-query-interface
plan: 05
type: execute
wave: 3
depends_on:
  - "06-02"
  - "06-03"
files_modified:
  - listener/public/stats.js
  - listener/public/app.js
  - listener/public/index.html
  - listener/public/styles.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Statistics view shows aggregate data for selected project"
    - "Statistics view includes duration percentiles (p50, p95, p99)"
    - "User can navigate between Requests and Statistics views"
    - "Charts visualize statistics data"
  artifacts:
    - path: "listener/public/stats.js"
      provides: "Statistics view with Chart.js integration"
      exports: ["showStats", "hideStats"]
  key_links:
    - from: "listener/public/stats.js"
      to: "/api/stats"
      via: "fetch call for statistics"
      pattern: "fetch.*api/stats"
    - from: "listener/public/app.js"
      to: "listener/public/stats.js"
      via: "import for view switching"
      pattern: "import.*stats.js"
---

<objective>
Create statistics view with charts and aggregate metrics visualization.

Purpose: Provide a statistics dashboard view showing aggregate performance data, percentiles, and trends. Uses Chart.js for visualization.

Output:
- Statistics view component with project filter
- Chart.js bar chart for percentile visualization
- View switching between Requests and Statistics
- Project-level aggregate metrics
</objective>

<execution_context>
@/Users/andrewvonhoesslin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrewvonhoesslin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-query-interface-a-visualization/06-RESEARCH.md
@.planning/phases/06-query-interface-a-visualization/06-02-SUMMARY.md
@.planning/phases/06-query-interface-a-visualization/06-03-SUMMARY.md

# Existing codebase context
@listener/public/index.html
@listener/public/app.js
@listener/public/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create statistics view module</name>
  <files>
    listener/public/stats.js
  </files>
  <action>
Create `listener/public/stats.js`:

```javascript
/**
 * Statistics View Module
 *
 * Displays aggregate statistics and percentile charts.
 * Uses Chart.js for visualization.
 */

let currentChart = null;
let chartLibraryLoaded = false;

/**
 * Load Chart.js library dynamically
 */
async function loadChartJs() {
  if (chartLibraryLoaded) return;

  return new Promise((resolve, reject) => {
    if (window.Chart) {
      chartLibraryLoaded = true;
      resolve();
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
    script.onload = () => {
      chartLibraryLoaded = true;
      resolve();
    };
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

/**
 * Show statistics view
 *
 * @param {HTMLElement} container - Container element
 * @param {string|null} project - Optional project filter
 */
export async function showStats(container, project = null) {
  // Cleanup previous chart
  hideStats();

  // Show loading
  container.innerHTML = `
    <div class="stats-loading" aria-busy="true">
      Loading statistics...
    </div>
  `;

  try {
    // Load Chart.js
    await loadChartJs();

    // Fetch projects for filter
    const projectsResponse = await fetch('/api/projects');
    const projectsData = await projectsResponse.json();
    const projects = projectsData.projects || [];

    // Fetch statistics
    const statsUrl = project ? `/api/stats?project=${encodeURIComponent(project)}` : '/api/stats';
    const statsResponse = await fetch(statsUrl);

    if (!statsResponse.ok) {
      throw new Error('Failed to load statistics');
    }

    const stats = await statsResponse.json();

    // Render stats view
    container.innerHTML = `
      <div class="stats-view">
        <div class="stats-header">
          <h3>Statistics${project ? `: ${escapeHtml(project)}` : ' (All Projects)'}</h3>
          <div class="stats-project-filter">
            <label for="stats-project">Project:</label>
            <select id="stats-project">
              <option value="">All Projects</option>
              ${projects.map(p => `<option value="${escapeHtml(p)}" ${p === project ? 'selected' : ''}>${escapeHtml(p)}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stats-card">
            <span class="stats-value">${formatNumber(stats.total_records)}</span>
            <span class="stats-label">Total Records</span>
          </div>
          <div class="stats-card">
            <span class="stats-value">${formatNumber(stats.total_php_requests)}</span>
            <span class="stats-label">PHP Requests</span>
          </div>
          <div class="stats-card">
            <span class="stats-value">${formatNumber(stats.total_postgres_records)}</span>
            <span class="stats-label">Postgres Records</span>
          </div>
          <div class="stats-card">
            <span class="stats-value">${stats.avg_duration ? stats.avg_duration.toFixed(0) + 'ms' : '-'}</span>
            <span class="stats-label">Avg Duration</span>
          </div>
        </div>

        <div class="stats-dates">
          <p>Data range: ${formatDate(stats.oldest_timestamp)} to ${formatDate(stats.newest_timestamp)}</p>
        </div>

        <!-- URL Stats Section -->
        <div class="stats-url-section">
          <h4>URL Statistics</h4>
          <div class="stats-url-form">
            <input type="text" id="stats-url" placeholder="Enter URL pattern (e.g., /api/users)" value="">
            <button id="stats-url-btn" class="secondary">Analyze URL</button>
          </div>
          <div id="stats-url-results"></div>
        </div>

        <!-- Chart Section -->
        <div class="stats-chart-section">
          <h4>Records by Source</h4>
          <div class="chart-container">
            <canvas id="stats-chart"></canvas>
          </div>
        </div>
      </div>
    `;

    // Add event listeners
    const projectSelect = container.querySelector('#stats-project');
    projectSelect.addEventListener('change', (e) => {
      showStats(container, e.target.value || null);
    });

    const urlBtn = container.querySelector('#stats-url-btn');
    const urlInput = container.querySelector('#stats-url');
    urlBtn.addEventListener('click', () => analyzeUrl(project, urlInput.value, container.querySelector('#stats-url-results')));
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        analyzeUrl(project, urlInput.value, container.querySelector('#stats-url-results'));
      }
    });

    // Render chart
    renderSourceChart(stats);

  } catch (error) {
    console.error('[Stats] Failed to load statistics:', error);
    container.innerHTML = `
      <div class="stats-error">
        <p>Failed to load statistics: ${escapeHtml(error.message)}</p>
      </div>
    `;
  }
}

/**
 * Analyze URL statistics
 */
async function analyzeUrl(project, url, container) {
  if (!url) {
    container.innerHTML = '<p class="stats-hint">Enter a URL pattern to see detailed statistics</p>';
    return;
  }

  container.innerHTML = '<div aria-busy="true">Analyzing...</div>';

  try {
    const params = new URLSearchParams();
    if (project) params.set('project', project);
    params.set('url', url);

    const response = await fetch(`/api/stats?${params.toString()}`);

    if (!response.ok) {
      throw new Error('Failed to analyze URL');
    }

    const stats = await response.json();

    if (!stats.count || stats.count === 0) {
      container.innerHTML = `<p class="stats-hint">No data found for URL pattern: ${escapeHtml(url)}</p>`;
      return;
    }

    container.innerHTML = `
      <div class="url-stats-results">
        <h5>URL: ${escapeHtml(stats.url || url)}</h5>
        <div class="url-stats-grid">
          <div class="url-stats-item">
            <span class="value">${formatNumber(stats.count)}</span>
            <span class="label">Requests</span>
          </div>
          <div class="url-stats-item">
            <span class="value">${stats.avg_duration?.toFixed(0) || '-'}ms</span>
            <span class="label">Average</span>
          </div>
          <div class="url-stats-item">
            <span class="value">${stats.min_duration?.toFixed(0) || '-'}ms</span>
            <span class="label">Min</span>
          </div>
          <div class="url-stats-item">
            <span class="value">${stats.max_duration?.toFixed(0) || '-'}ms</span>
            <span class="label">Max</span>
          </div>
        </div>
        ${stats.p50 !== null ? `
        <div class="url-stats-percentiles">
          <h6>Duration Percentiles</h6>
          <div class="percentile-chart-container">
            <canvas id="percentile-chart"></canvas>
          </div>
        </div>
        ` : '<p class="stats-hint">Percentile data requires more samples</p>'}
      </div>
    `;

    // Render percentile chart if data available
    if (stats.p50 !== null) {
      renderPercentileChart(stats);
    }

  } catch (error) {
    console.error('[Stats] URL analysis failed:', error);
    container.innerHTML = `<p class="stats-error">Analysis failed: ${escapeHtml(error.message)}</p>`;
  }
}

/**
 * Render source distribution chart
 */
function renderSourceChart(stats) {
  const canvas = document.getElementById('stats-chart');
  if (!canvas || !window.Chart) return;

  // Destroy existing chart
  if (currentChart) {
    currentChart.destroy();
  }

  const ctx = canvas.getContext('2d');
  currentChart = new window.Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['PHP Requests', 'Postgres Records'],
      datasets: [{
        data: [stats.total_php_requests || 0, stats.total_postgres_records || 0],
        backgroundColor: [
          'rgba(54, 162, 235, 0.7)',
          'rgba(255, 159, 64, 0.7)',
        ],
        borderColor: [
          'rgb(54, 162, 235)',
          'rgb(255, 159, 64)',
        ],
        borderWidth: 1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
      },
    },
  });
}

/**
 * Render percentile bar chart
 */
function renderPercentileChart(stats) {
  const canvas = document.getElementById('percentile-chart');
  if (!canvas || !window.Chart) return;

  const ctx = canvas.getContext('2d');
  new window.Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Min', 'P50', 'Avg', 'P95', 'P99', 'Max'],
      datasets: [{
        label: 'Duration (ms)',
        data: [
          stats.min_duration || 0,
          stats.p50 || 0,
          stats.avg_duration || 0,
          stats.p95 || 0,
          stats.p99 || 0,
          stats.max_duration || 0,
        ],
        backgroundColor: [
          'rgba(75, 192, 192, 0.7)',
          'rgba(54, 162, 235, 0.7)',
          'rgba(153, 102, 255, 0.7)',
          'rgba(255, 206, 86, 0.7)',
          'rgba(255, 159, 64, 0.7)',
          'rgba(255, 99, 132, 0.7)',
        ],
        borderColor: [
          'rgb(75, 192, 192)',
          'rgb(54, 162, 235)',
          'rgb(153, 102, 255)',
          'rgb(255, 206, 86)',
          'rgb(255, 159, 64)',
          'rgb(255, 99, 132)',
        ],
        borderWidth: 1,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false,
        },
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Duration (ms)',
          },
        },
      },
    },
  });
}

/**
 * Hide statistics view and cleanup
 */
export function hideStats() {
  if (currentChart) {
    currentChart.destroy();
    currentChart = null;
  }
}

// Utility functions

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

function formatNumber(num) {
  if (num === null || num === undefined) return '-';
  return num.toLocaleString();
}

function formatDate(timestamp) {
  if (!timestamp) return '-';
  return new Date(timestamp * 1000).toLocaleDateString();
}
```
  </action>
  <verify>
```bash
head -50 /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/stats.js
grep -c "export.*function" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/stats.js
```
stats.js exists with showStats and hideStats exports.
  </verify>
  <done>
Statistics view module loads Chart.js dynamically, fetches stats from API, renders overview cards, URL analysis form, and charts for source distribution and percentiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add statistics section to HTML and navigation</name>
  <files>
    listener/public/index.html
  </files>
  <action>
Modify `listener/public/index.html`:

1. Add statistics section after the results-section and before the detail-panel:
```html
<!-- Statistics Section (hidden by default) -->
<section id="stats-section" hidden>
  <!-- Populated by stats.js -->
</section>
```

2. Ensure the navigation links have correct IDs (should already be in place):
```html
<nav>
  <ul>
    <li><strong>Bitville APM</strong></li>
  </ul>
  <ul>
    <li><a href="#" id="nav-requests" class="active">Requests</a></li>
    <li><a href="#" id="nav-stats">Statistics</a></li>
  </ul>
</nav>
```

The full structure should be:
- header with nav
- main.container containing:
  - search-section (for request filters)
  - results-section (request list table)
  - stats-section (statistics view, hidden by default)
  - detail-panel (request detail, hidden by default)
  - detail-modal (legacy modal, can be removed or kept as fallback)
- footer
  </action>
  <verify>
```bash
grep -A 2 "stats-section" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/index.html
grep "nav-stats" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/index.html
```
stats-section and nav-stats present in HTML.
  </verify>
  <done>
Statistics section added to HTML. Navigation links present for view switching.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate view switching in app.js and add styles</name>
  <files>
    listener/public/app.js
    listener/public/styles.css
  </files>
  <action>
Modify `listener/public/app.js`:

1. Add import at the top:
```javascript
import { showStats, hideStats } from './stats.js';
```

2. Add stats section to elements cache:
```javascript
elements = {
  // ... existing elements ...
  navRequests: document.getElementById('nav-requests'),
  navStats: document.getElementById('nav-stats'),
  searchSection: document.getElementById('search-section'),
  resultsSection: document.getElementById('results-section'),
  statsSection: document.getElementById('stats-section'),
};
```

3. Add state tracking for current view:
```javascript
let state = {
  // ... existing state ...
  currentView: 'requests',  // 'requests' or 'stats'
};
```

4. Add view switching handlers in init():
```javascript
// View navigation
elements.navRequests.addEventListener('click', (e) => {
  e.preventDefault();
  switchView('requests');
});

elements.navStats.addEventListener('click', (e) => {
  e.preventDefault();
  switchView('stats');
});
```

5. Add switchView function:
```javascript
/**
 * Switch between views
 */
function switchView(view) {
  state.currentView = view;

  // Update nav active state
  elements.navRequests.classList.toggle('active', view === 'requests');
  elements.navStats.classList.toggle('active', view === 'stats');

  // Show/hide sections
  elements.searchSection.hidden = view !== 'requests';
  elements.resultsSection.hidden = view !== 'requests';
  elements.statsSection.hidden = view !== 'stats';

  // Hide detail panel when switching views
  if (elements.detailPanel) {
    elements.detailPanel.hidden = true;
  }

  // Load content for view
  if (view === 'stats') {
    showStats(elements.statsSection, elements.projectFilter.value || null);
  } else {
    hideStats();
  }
}
```

Update `listener/public/styles.css` with statistics view styles:

```css
/* Statistics View */
.stats-view {
  max-width: 1000px;
}

.stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.stats-header h3 {
  margin: 0;
}

.stats-project-filter {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.stats-project-filter select {
  margin: 0;
  width: auto;
  min-width: 150px;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.stats-card {
  text-align: center;
  padding: 1.5rem 1rem;
  background: var(--pico-card-background-color);
  border-radius: var(--pico-border-radius);
  border: 1px solid var(--pico-muted-border-color);
}

.stats-value {
  display: block;
  font-size: 2rem;
  font-weight: bold;
  color: var(--pico-primary);
  margin-bottom: 0.5rem;
}

.stats-label {
  font-size: 0.9rem;
  color: var(--pico-muted-color);
}

.stats-dates {
  text-align: center;
  color: var(--pico-muted-color);
  margin-bottom: 2rem;
}

/* URL Stats Section */
.stats-url-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: var(--pico-card-background-color);
  border-radius: var(--pico-border-radius);
}

.stats-url-section h4 {
  margin-top: 0;
  margin-bottom: 1rem;
}

.stats-url-form {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.stats-url-form input {
  flex: 1;
  margin: 0;
}

.stats-url-form button {
  margin: 0;
  white-space: nowrap;
}

.url-stats-results h5 {
  margin-top: 1rem;
  margin-bottom: 1rem;
  word-break: break-all;
}

.url-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

@media (max-width: 768px) {
  .url-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.url-stats-item {
  text-align: center;
  padding: 1rem;
  background: var(--pico-background-color);
  border-radius: var(--pico-border-radius);
}

.url-stats-item .value {
  display: block;
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.25rem;
}

.url-stats-item .label {
  font-size: 0.85rem;
  color: var(--pico-muted-color);
}

.url-stats-percentiles {
  margin-top: 1.5rem;
}

.url-stats-percentiles h6 {
  margin-bottom: 1rem;
}

.percentile-chart-container {
  max-width: 500px;
  margin: 0 auto;
}

/* Chart Section */
.stats-chart-section {
  margin-bottom: 2rem;
}

.stats-chart-section h4 {
  margin-bottom: 1rem;
}

.chart-container {
  max-width: 400px;
  margin: 0 auto;
}

/* Stats States */
.stats-loading {
  text-align: center;
  padding: 3rem;
}

.stats-error {
  text-align: center;
  padding: 2rem;
  color: var(--pico-del-color);
}

.stats-hint {
  text-align: center;
  color: var(--pico-muted-color);
  font-style: italic;
  padding: 1rem;
}

/* Navigation active state */
nav a.active {
  font-weight: bold;
  text-decoration: underline;
}
```
  </action>
  <verify>
```bash
# Check app.js has stats import and switchView
grep "import.*stats.js" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/app.js
grep "switchView" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/app.js

# Check styles has stats classes
grep "stats-grid" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/styles.css
grep "stats-card" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/styles.css
```
View switching integrated in app.js. Statistics styles present.
  </verify>
  <done>
View switching between Requests and Statistics works. Statistics view shows aggregate metrics, URL analysis with percentile charts. Navigation highlights active view.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Click "Statistics" in navigation:
   - Search and results sections hide
   - Statistics view shows with cards

2. Statistics overview shows:
   - Total records, PHP requests, Postgres records
   - Average duration
   - Date range
   - Source distribution chart

3. URL analysis:
   - Enter URL pattern and click Analyze
   - Shows request count, avg/min/max duration
   - Percentile chart (if enough data)

4. Project filter works:
   - Change project dropdown
   - Statistics refresh for selected project

5. Switch back to "Requests":
   - Statistics section hides
   - Search and results return
</verification>

<success_criteria>
1. Navigation switches between Requests and Statistics views
2. Statistics view shows aggregate metrics (total records, avg duration)
3. Source distribution chart (doughnut) renders correctly
4. URL analysis returns percentile data (p50, p95, p99)
5. Percentile bar chart visualizes duration distribution
6. Project filter updates statistics for selected project
7. Chart cleanup prevents memory leaks on view switch
</success_criteria>

<output>
After completion, create `.planning/phases/06-query-interface-a-visualization/06-05-SUMMARY.md`
</output>

---
phase: 06-query-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - listener/public/index.html
  - listener/public/app.js
  - listener/public/styles.css
  - listener/src/server.ts
  - listener/package.json
autonomous: true

must_haves:
  truths:
    - "Web UI is served at root URL of listener"
    - "Dashboard displays loading state while fetching data"
    - "Dashboard shows basic layout with header, search area, and results area"
    - "Static assets are bundled and served by Bun"
  artifacts:
    - path: "listener/public/index.html"
      provides: "Dashboard HTML entry point"
      contains: "<!DOCTYPE html>"
    - path: "listener/public/app.js"
      provides: "Dashboard JavaScript application"
      exports: ["init"]
    - path: "listener/public/styles.css"
      provides: "Custom styles extending Pico CSS"
      contains: ".dashboard"
  key_links:
    - from: "listener/src/server.ts"
      to: "listener/public/index.html"
      via: "Bun HTML import"
      pattern: "import.*index\\.html"
    - from: "listener/public/index.html"
      to: "listener/public/app.js"
      via: "script module import"
      pattern: "script.*type.*module.*app\\.js"
---

<objective>
Create the web UI foundation with HTML dashboard served by the listener (QUERY-01).

Purpose: Serve a basic web dashboard directly from the listener server for viewing profiling data. Uses Pico CSS for semantic styling and vanilla JavaScript for simplicity.

Output:
- HTML dashboard served at listener root URL
- Pico CSS integration for semantic styling
- JavaScript module structure for dashboard logic
- Bun HTML imports for automatic bundling
</objective>

<execution_context>
@/Users/andrewvonhoesslin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrewvonhoesslin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-query-interface-a-visualization/06-RESEARCH.md

# Existing codebase context
@listener/src/server.ts
@listener/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTML dashboard structure</name>
  <files>
    listener/public/index.html
    listener/public/styles.css
  </files>
  <action>
Create `listener/public/` directory and `listener/public/index.html`:

```html
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitville APM Dashboard</title>
  <!-- Pico CSS for semantic styling (11KB) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="container">
    <nav>
      <ul>
        <li><strong>Bitville APM</strong></li>
      </ul>
      <ul>
        <li><a href="#" id="nav-requests" class="active">Requests</a></li>
        <li><a href="#" id="nav-stats">Statistics</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <!-- Search/Filter Section -->
    <section id="search-section">
      <form id="search-form" role="search">
        <div class="grid">
          <div>
            <label for="project-filter">Project</label>
            <select id="project-filter" name="project">
              <option value="">All Projects</option>
              <!-- Populated dynamically -->
            </select>
          </div>
          <div>
            <label for="url-filter">URL Pattern</label>
            <input type="text" id="url-filter" name="url" placeholder="/api/users">
          </div>
          <div>
            <label for="duration-min">Min Duration (ms)</label>
            <input type="number" id="duration-min" name="duration_min" placeholder="500">
          </div>
        </div>
        <div class="grid">
          <div>
            <label for="source-filter">Source</label>
            <select id="source-filter" name="source">
              <option value="">All Sources</option>
              <option value="php_agent">PHP Agent</option>
              <option value="postgres_agent">Postgres Agent</option>
            </select>
          </div>
          <div>
            <label for="date-start">Start Date</label>
            <input type="datetime-local" id="date-start" name="timestamp_start">
          </div>
          <div>
            <label for="date-end">End Date</label>
            <input type="datetime-local" id="date-end" name="timestamp_end">
          </div>
        </div>
        <button type="submit">Search</button>
      </form>
    </section>

    <!-- Results Section -->
    <section id="results-section">
      <div id="loading" class="loading-indicator" hidden>
        <span aria-busy="true">Loading...</span>
      </div>
      <div id="error-message" class="error-message" hidden></div>
      <div id="results-info"></div>
      <table id="results-table" role="grid">
        <thead>
          <tr>
            <th scope="col">Timestamp</th>
            <th scope="col">Project</th>
            <th scope="col">URL</th>
            <th scope="col">Duration</th>
            <th scope="col">Source</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="results-body">
          <!-- Populated dynamically -->
        </tbody>
      </table>
      <div id="pagination">
        <button id="load-more" hidden>Load More</button>
      </div>
    </section>

    <!-- Detail Modal (for viewing individual requests) -->
    <dialog id="detail-modal">
      <article>
        <header>
          <button aria-label="Close" rel="prev" id="close-modal"></button>
          <h2 id="modal-title">Request Details</h2>
        </header>
        <div id="modal-content">
          <!-- Populated when viewing a request -->
        </div>
        <footer>
          <button id="modal-close-btn">Close</button>
        </footer>
      </article>
    </dialog>
  </main>

  <footer class="container">
    <small>Bitville APM &copy; 2026 | <span id="status-indicator">Connecting...</span></small>
  </footer>

  <script type="module" src="./app.js"></script>
</body>
</html>
```

Create `listener/public/styles.css`:

```css
/* Dashboard-specific styles extending Pico CSS */

/* Layout adjustments */
.container {
  max-width: 1400px;
}

/* Search form */
#search-section {
  margin-bottom: 2rem;
  padding: 1rem;
  background: var(--pico-card-background-color);
  border-radius: var(--pico-border-radius);
}

#search-form .grid {
  margin-bottom: 1rem;
}

#search-form button[type="submit"] {
  width: auto;
  margin-top: 0.5rem;
}

/* Results table */
#results-table {
  margin-top: 1rem;
}

#results-table tbody tr {
  cursor: pointer;
}

#results-table tbody tr:hover {
  background: var(--pico-secondary-hover-background);
}

/* Duration column color coding */
.duration-fast {
  color: var(--pico-ins-color);
}

.duration-medium {
  color: var(--pico-mark-color);
}

.duration-slow {
  color: var(--pico-del-color);
}

/* Loading indicator */
.loading-indicator {
  text-align: center;
  padding: 2rem;
}

/* Error message */
.error-message {
  background: var(--pico-del-color);
  color: white;
  padding: 1rem;
  border-radius: var(--pico-border-radius);
  margin-bottom: 1rem;
}

/* Pagination */
#pagination {
  text-align: center;
  margin-top: 1rem;
}

/* Results info */
#results-info {
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  color: var(--pico-muted-color);
}

/* Modal content */
#modal-content {
  max-height: 60vh;
  overflow-y: auto;
}

#modal-content pre {
  font-size: 0.8rem;
  overflow-x: auto;
}

/* Status indicator */
#status-indicator {
  font-weight: 500;
}

.status-connected {
  color: var(--pico-ins-color);
}

.status-error {
  color: var(--pico-del-color);
}

/* Dark mode adjustments */
[data-theme="dark"] #search-section {
  background: var(--pico-card-background-color);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #search-form .grid {
    grid-template-columns: 1fr;
  }

  #results-table {
    font-size: 0.85rem;
  }

  #results-table th:nth-child(4),
  #results-table td:nth-child(4),
  #results-table th:nth-child(5),
  #results-table td:nth-child(5) {
    display: none;
  }
}
```
  </action>
  <verify>
```bash
ls -la /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/
cat /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/index.html | head -20
```
Files exist and contain expected content.
  </verify>
  <done>
HTML dashboard with semantic Pico CSS structure exists. Search form with filters, results table, detail modal, and footer status indicator are in place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JavaScript application module</name>
  <files>
    listener/public/app.js
  </files>
  <action>
Create `listener/public/app.js`:

```javascript
/**
 * Bitville APM Dashboard Application
 *
 * Vanilla JavaScript dashboard for viewing profiling data.
 * Uses fetch API for data loading, no external dependencies.
 */

// State
let state = {
  currentCursor: null,
  isLoading: false,
  currentFilters: {},
  results: [],
};

// DOM Elements (cached after init)
let elements = {};

/**
 * Initialize dashboard
 */
export function init() {
  // Cache DOM elements
  elements = {
    searchForm: document.getElementById('search-form'),
    projectFilter: document.getElementById('project-filter'),
    urlFilter: document.getElementById('url-filter'),
    durationMin: document.getElementById('duration-min'),
    sourceFilter: document.getElementById('source-filter'),
    dateStart: document.getElementById('date-start'),
    dateEnd: document.getElementById('date-end'),
    loading: document.getElementById('loading'),
    errorMessage: document.getElementById('error-message'),
    resultsInfo: document.getElementById('results-info'),
    resultsBody: document.getElementById('results-body'),
    loadMore: document.getElementById('load-more'),
    detailModal: document.getElementById('detail-modal'),
    modalTitle: document.getElementById('modal-title'),
    modalContent: document.getElementById('modal-content'),
    closeModal: document.getElementById('close-modal'),
    modalCloseBtn: document.getElementById('modal-close-btn'),
    statusIndicator: document.getElementById('status-indicator'),
  };

  // Event listeners
  elements.searchForm.addEventListener('submit', handleSearch);
  elements.loadMore.addEventListener('click', loadMoreResults);
  elements.closeModal.addEventListener('click', closeModal);
  elements.modalCloseBtn.addEventListener('click', closeModal);
  elements.detailModal.addEventListener('click', (e) => {
    if (e.target === elements.detailModal) closeModal();
  });

  // Load initial data
  loadProjects();
  performSearch();

  console.log('[Dashboard] Initialized');
}

/**
 * Load project list for filter dropdown
 */
async function loadProjects() {
  try {
    const response = await fetch('/api/projects');
    if (!response.ok) throw new Error('Failed to load projects');

    const data = await response.json();
    const select = elements.projectFilter;

    // Clear existing options (keep "All Projects")
    while (select.options.length > 1) {
      select.remove(1);
    }

    // Add project options
    data.projects.forEach(project => {
      const option = document.createElement('option');
      option.value = project;
      option.textContent = project;
      select.appendChild(option);
    });

    updateStatus('Connected', true);
  } catch (error) {
    console.error('[Dashboard] Failed to load projects:', error);
    updateStatus('Error loading projects', false);
  }
}

/**
 * Handle search form submission
 */
function handleSearch(event) {
  event.preventDefault();
  state.currentCursor = null;
  state.results = [];
  performSearch();
}

/**
 * Perform search with current filters
 */
async function performSearch() {
  if (state.isLoading) return;

  showLoading(true);
  hideError();

  try {
    // Build query parameters
    const params = new URLSearchParams();

    const project = elements.projectFilter.value;
    if (project) params.set('project', project);

    const url = elements.urlFilter.value;
    if (url) params.set('url', url);

    const durationMin = elements.durationMin.value;
    if (durationMin) params.set('duration_min', durationMin);

    const source = elements.sourceFilter.value;
    if (source) params.set('source', source);

    const dateStart = elements.dateStart.value;
    if (dateStart) {
      params.set('timestamp_start', Math.floor(new Date(dateStart).getTime() / 1000));
    }

    const dateEnd = elements.dateEnd.value;
    if (dateEnd) {
      params.set('timestamp_end', Math.floor(new Date(dateEnd).getTime() / 1000));
    }

    if (state.currentCursor) {
      params.set('after', state.currentCursor);
    }

    params.set('limit', '50');

    // Fetch results
    const response = await fetch(`/api/search?${params.toString()}`);
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Search failed');
    }

    const data = await response.json();

    // Update state
    state.results = state.currentCursor ? [...state.results, ...data.items] : data.items;
    state.currentCursor = data.cursor;
    state.currentFilters = Object.fromEntries(params);

    // Render results
    renderResults(state.currentCursor === null);
    elements.loadMore.hidden = !data.hasMore;

    updateStatus('Connected', true);
  } catch (error) {
    console.error('[Dashboard] Search failed:', error);
    showError(error.message);
    updateStatus('Error', false);
  } finally {
    showLoading(false);
  }
}

/**
 * Load more results (pagination)
 */
function loadMoreResults() {
  performSearch();
}

/**
 * Render results to table
 */
function renderResults(clearExisting = true) {
  const tbody = elements.resultsBody;

  if (clearExisting) {
    tbody.innerHTML = '';
  }

  if (state.results.length === 0) {
    elements.resultsInfo.textContent = 'No results found';
    return;
  }

  elements.resultsInfo.textContent = `Showing ${state.results.length} results`;

  // Only render new items when appending
  const startIndex = clearExisting ? 0 : state.results.length - 50;
  const items = clearExisting ? state.results : state.results.slice(startIndex);

  items.forEach(item => {
    const row = document.createElement('tr');
    row.dataset.id = item.id;
    row.dataset.correlationId = item.correlation_id;

    // Format timestamp
    const date = new Date(item.timestamp * 1000);
    const formattedDate = date.toLocaleString();

    // Format duration with color coding
    const duration = item.duration_ms;
    let durationClass = 'duration-fast';
    if (duration > 1000) durationClass = 'duration-slow';
    else if (duration > 500) durationClass = 'duration-medium';

    // Extract URL from payload if virtual column not available
    let url = item.url || '';
    if (!url && item.payload) {
      try {
        const payload = JSON.parse(item.payload);
        url = payload.request?.uri || payload.url || '-';
      } catch (e) {
        url = '-';
      }
    }

    row.innerHTML = `
      <td>${formattedDate}</td>
      <td>${escapeHtml(item.project)}</td>
      <td title="${escapeHtml(url)}">${truncate(url, 40)}</td>
      <td class="${durationClass}">${duration ? duration.toFixed(0) + 'ms' : '-'}</td>
      <td>${item.source}</td>
      <td><button class="secondary outline" data-action="view">View</button></td>
    `;

    // Click handler for row
    row.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'view' || e.target.tagName !== 'BUTTON') {
        viewRequestDetails(item);
      }
    });

    tbody.appendChild(row);
  });
}

/**
 * View request details in modal
 */
function viewRequestDetails(item) {
  elements.modalTitle.textContent = `Request: ${item.correlation_id.slice(0, 8)}...`;

  let payload = {};
  try {
    payload = JSON.parse(item.payload);
  } catch (e) {
    payload = { error: 'Failed to parse payload', raw: item.payload };
  }

  elements.modalContent.innerHTML = `
    <h4>Overview</h4>
    <dl>
      <dt>Correlation ID</dt>
      <dd><code>${item.correlation_id}</code></dd>
      <dt>Project</dt>
      <dd>${escapeHtml(item.project)}</dd>
      <dt>Source</dt>
      <dd>${item.source}</dd>
      <dt>Duration</dt>
      <dd>${item.duration_ms ? item.duration_ms.toFixed(0) + 'ms' : '-'}</dd>
      <dt>Timestamp</dt>
      <dd>${new Date(item.timestamp * 1000).toLocaleString()}</dd>
    </dl>

    <h4>Payload</h4>
    <pre><code>${escapeHtml(JSON.stringify(payload, null, 2))}</code></pre>
  `;

  elements.detailModal.showModal();
}

/**
 * Close detail modal
 */
function closeModal() {
  elements.detailModal.close();
}

// Utility functions

function showLoading(show) {
  state.isLoading = show;
  elements.loading.hidden = !show;
}

function showError(message) {
  elements.errorMessage.textContent = message;
  elements.errorMessage.hidden = false;
}

function hideError() {
  elements.errorMessage.hidden = true;
}

function updateStatus(text, connected) {
  elements.statusIndicator.textContent = text;
  elements.statusIndicator.className = connected ? 'status-connected' : 'status-error';
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function truncate(text, maxLength) {
  if (!text || text.length <= maxLength) return text || '';
  return text.slice(0, maxLength) + '...';
}

// Initialize on DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
```
  </action>
  <verify>
```bash
# Check file exists and has expected exports
head -30 /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/app.js
grep -c "export function init" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/app.js
```
File exists with init export and proper JavaScript structure.
  </verify>
  <done>
JavaScript application module with search, pagination, and detail view functions. State management pattern prevents memory leaks. Uses fetch API for data loading.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate dashboard with Bun server</name>
  <files>
    listener/src/server.ts
  </files>
  <action>
Modify `listener/src/server.ts` to serve the web UI:

1. At the top of the file, add HTML import (Bun's HTML imports):
```typescript
// Import dashboard HTML for serving at root
// Bun automatically bundles referenced JS/CSS files
import dashboard from "../public/index.html";
```

**Note:** Bun 1.2+ automatically bundles JavaScript and CSS referenced in HTML files. The import returns a Response-compatible object that can be served directly.

2. Add route for dashboard before the health check route (around line 92):
```typescript
// Dashboard UI (Phase 6) - serve at root
if (req.method === "GET" && url.pathname === "/") {
  return new Response(dashboard);
}

// Serve static assets from public directory
if (req.method === "GET" && url.pathname.startsWith("/public/")) {
  const filePath = url.pathname.replace("/public/", "");
  const file = Bun.file(import.meta.dir + "/../public/" + filePath);
  if (await file.exists()) {
    return new Response(file);
  }
}
```

**Alternative if Bun HTML imports don't work as expected:**
If the HTML import approach doesn't work (depends on Bun version), use static file serving:
```typescript
// Dashboard UI - serve static HTML
if (req.method === "GET" && url.pathname === "/") {
  const html = Bun.file(import.meta.dir + "/../public/index.html");
  return new Response(html, {
    headers: { "content-type": "text/html; charset=utf-8" },
  });
}

// Serve static assets (JS, CSS)
if (req.method === "GET" && (url.pathname.endsWith(".js") || url.pathname.endsWith(".css"))) {
  const filePath = import.meta.dir + "/../public" + url.pathname;
  const file = Bun.file(filePath);
  if (await file.exists()) {
    const contentType = url.pathname.endsWith(".js") ? "application/javascript" : "text/css";
    return new Response(file, {
      headers: { "content-type": contentType },
    });
  }
}
```

3. Update startup log messages to show dashboard URL:
```typescript
console.log(`[Listener] Dashboard: ${protocol.toLowerCase()}://localhost:${PORT}/`);
```
  </action>
  <verify>
```bash
cd /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener

# Start server briefly to test dashboard serving
BITVILLE_DB_PATH=/tmp/test-dashboard.db BITVILLE_API_KEY_TEST=test123 timeout 5 bun run src/server.ts &
sleep 2

# Test dashboard HTML is served
curl -s "http://localhost:8443/" | grep -o "Bitville APM Dashboard" | head -1

# Test static JS is served
curl -s "http://localhost:8443/app.js" | head -5

# Test static CSS is served
curl -s "http://localhost:8443/styles.css" | head -5

# Cleanup
pkill -f "bun run src/server.ts" 2>/dev/null || true
rm -f /tmp/test-dashboard.db*
```
Dashboard HTML and static assets are served correctly.
  </verify>
  <done>
Dashboard is served at listener root URL. Static JS and CSS files are accessible. Bun handles bundling automatically.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dashboard loads in browser:
```bash
# Start server
BITVILLE_DB_PATH=/tmp/test.db BITVILLE_API_KEY_TEST=test123 bun run listener/src/server.ts
# Open http://localhost:8443/ in browser
```

2. Dashboard shows:
   - Header with "Bitville APM"
   - Search form with filters (project, URL, duration, source, dates)
   - Results table (empty initially)
   - Footer with status indicator

3. No JavaScript console errors in browser DevTools
</verification>

<success_criteria>
1. Dashboard HTML served at listener root URL (/)
2. Pico CSS styling applied (semantic, responsive)
3. Search form has all filter fields (project, URL, duration, source, dates)
4. Results table structure ready for data
5. Detail modal opens/closes correctly
6. JavaScript loads without errors
7. Status indicator shows connection state
</success_criteria>

<output>
After completion, create `.planning/phases/06-query-interface-a-visualization/06-02-SUMMARY.md`
</output>

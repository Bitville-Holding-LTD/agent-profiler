---
phase: 06-query-interface
plan: 04
type: execute
wave: 3
depends_on:
  - "06-02"
  - "06-03"
files_modified:
  - listener/public/timeline.js
  - listener/public/detail.js
  - listener/public/app.js
  - listener/public/index.html
  - listener/public/styles.css
  - listener/package.json
autonomous: true

must_haves:
  truths:
    - "Timeline visualization shows PHP request as main span"
    - "Timeline visualization shows SQL queries as child spans"
    - "User can click a request to see timeline view"
    - "Comparative stats are displayed alongside request details"
    - "SQL queries are visually linked to the parent PHP request"
  artifacts:
    - path: "listener/public/timeline.js"
      provides: "vis-timeline integration for trace visualization"
      exports: ["renderTimeline", "destroyTimeline"]
    - path: "listener/public/detail.js"
      provides: "Request detail view with correlation and comparison"
      exports: ["showRequestDetail", "closeDetail"]
  key_links:
    - from: "listener/public/detail.js"
      to: "/api/correlation/:id"
      via: "fetch call for correlated records"
      pattern: "fetch.*api/correlation"
    - from: "listener/public/detail.js"
      to: "/api/compare"
      via: "fetch call for comparison data"
      pattern: "fetch.*api/compare"
    - from: "listener/public/timeline.js"
      to: "vis-timeline"
      via: "Timeline constructor"
      pattern: "new Timeline\\("
---

<objective>
Create timeline visualization and detail view showing PHP requests linked to SQL queries (QUERY-03, QUERY-04, QUERY-05).

Purpose: Visualize the request flow from PHP through database queries using a timeline/waterfall view. Show how a specific request compares to historical averages.

Output:
- vis-timeline integration for waterfall visualization
- Detail view showing correlated PHP + SQL records
- Comparative analysis display (this request vs average)
- Interactive timeline with zoom/pan
</objective>

<execution_context>
@/Users/andrewvonhoesslin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrewvonhoesslin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-query-interface-a-visualization/06-RESEARCH.md
@.planning/phases/06-query-interface-a-visualization/06-01-SUMMARY.md
@.planning/phases/06-query-interface-a-visualization/06-02-SUMMARY.md
@.planning/phases/06-query-interface-a-visualization/06-03-SUMMARY.md

# Existing codebase context
@listener/public/index.html
@listener/public/app.js
@listener/public/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vis-timeline and create timeline module</name>
  <files>
    listener/package.json
    listener/public/timeline.js
  </files>
  <action>
First, add vis-timeline to the project:
```bash
cd /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener
bun add vis-timeline
```

Create `listener/public/timeline.js`:

```javascript
/**
 * Timeline Visualization Module
 *
 * Uses vis-timeline to render request traces as waterfall diagrams.
 * Shows PHP request as main span with SQL queries as child spans.
 */

// Import vis-timeline (will be bundled by Bun)
// Note: vis-timeline needs to be loaded from CDN or bundled specially
// For simplicity, we'll use the standalone version via dynamic import

let Timeline = null;
let currentTimeline = null;

/**
 * Load vis-timeline library dynamically
 */
async function loadVisTimeline() {
  if (Timeline) return Timeline;

  // Load from CDN (vis-timeline standalone includes all dependencies)
  return new Promise((resolve, reject) => {
    if (window.vis && window.vis.Timeline) {
      Timeline = window.vis.Timeline;
      resolve(Timeline);
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js';
    script.onload = () => {
      Timeline = window.vis.Timeline;
      resolve(Timeline);
    };
    script.onerror = reject;
    document.head.appendChild(script);

    // Also load CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css';
    document.head.appendChild(link);
  });
}

/**
 * Render timeline visualization for a trace
 *
 * @param {HTMLElement} container - DOM element to render into
 * @param {Object} traceData - Trace data from /api/correlation/:id
 * @returns {Function} Cleanup function to destroy timeline
 */
export async function renderTimeline(container, traceData) {
  await loadVisTimeline();

  // Destroy existing timeline if any
  destroyTimeline();

  if (!traceData || !traceData.trace) {
    container.innerHTML = '<p>No trace data available</p>';
    return () => {};
  }

  const { php_request, sql_queries } = traceData.trace;

  // Build timeline items
  const items = [];
  const groups = [
    { id: 'php', content: 'PHP Request', className: 'timeline-group-php' },
    { id: 'sql', content: 'SQL Queries', className: 'timeline-group-sql' },
  ];

  // PHP request span
  if (php_request) {
    const payload = typeof php_request.payload === 'string'
      ? JSON.parse(php_request.payload)
      : php_request.payload;

    const startTime = php_request.timestamp * 1000;
    const duration = php_request.duration_ms || payload.timing?.duration_ms || 0;
    const endTime = startTime + duration;

    items.push({
      id: `php-${php_request.id}`,
      group: 'php',
      content: truncateUrl(payload.request?.uri || 'PHP Request'),
      start: new Date(startTime),
      end: new Date(endTime),
      className: 'timeline-item-php',
      title: `${payload.request?.method || 'GET'} ${payload.request?.uri || ''}\nDuration: ${duration.toFixed(0)}ms`,
    });

    // Add SQL queries from PHP payload if available
    if (payload.sql && payload.sql.queries) {
      let sqlOffset = 0;
      payload.sql.queries.slice(0, 50).forEach((query, idx) => {
        const queryStart = startTime + sqlOffset;
        const queryEnd = queryStart + (query.duration_ms || 1);
        sqlOffset += query.duration_ms || 1;

        items.push({
          id: `sql-inline-${idx}`,
          group: 'sql',
          content: truncateQuery(query.query),
          start: new Date(queryStart),
          end: new Date(queryEnd),
          className: getDurationClass(query.duration_ms),
          title: `${query.query}\nDuration: ${(query.duration_ms || 0).toFixed(2)}ms`,
        });
      });
    }
  }

  // SQL queries from postgres_agent (if any)
  if (sql_queries && sql_queries.length > 0) {
    sql_queries.slice(0, 50).forEach((record, idx) => {
      const payload = typeof record.payload === 'string'
        ? JSON.parse(record.payload)
        : record.payload;

      const startTime = record.timestamp * 1000;
      const duration = payload.duration_ms || payload.data?.duration_ms || 1;

      items.push({
        id: `pg-${record.id}`,
        group: 'sql',
        content: truncateQuery(payload.query || payload.data?.query || 'SQL Query'),
        start: new Date(startTime),
        end: new Date(startTime + duration),
        className: getDurationClass(duration),
        title: `${payload.query || payload.data?.query || 'Query'}\nDuration: ${duration.toFixed(2)}ms`,
      });
    });
  }

  if (items.length === 0) {
    container.innerHTML = '<p>No timeline data available</p>';
    return () => {};
  }

  // Calculate time range
  const times = items.flatMap(i => [i.start.getTime(), i.end.getTime()]);
  const minTime = Math.min(...times);
  const maxTime = Math.max(...times);
  const padding = (maxTime - minTime) * 0.1 || 100;

  // Timeline options
  const options = {
    stack: false,
    groupOrder: 'id',
    orientation: { axis: 'top', item: 'top' },
    margin: { item: { horizontal: 0, vertical: 5 } },
    min: new Date(minTime - padding),
    max: new Date(maxTime + padding),
    zoomMin: 1,  // 1ms minimum zoom
    zoomMax: 60000,  // 1 minute maximum
    tooltip: {
      followMouse: true,
      overflowMethod: 'cap',
    },
    format: {
      minorLabels: {
        millisecond: 'SSS[ms]',
        second: 's[s]',
        minute: 'HH:mm',
      },
      majorLabels: {
        millisecond: 'HH:mm:ss',
        second: 'HH:mm',
        minute: 'ddd D MMMM',
      },
    },
  };

  // Create timeline
  currentTimeline = new Timeline(container, items, groups, options);

  // Fit to show all items
  currentTimeline.fit();

  // Return cleanup function
  return () => destroyTimeline();
}

/**
 * Destroy current timeline instance
 */
export function destroyTimeline() {
  if (currentTimeline) {
    currentTimeline.destroy();
    currentTimeline = null;
  }
}

// Helper functions

function truncateUrl(url) {
  if (!url || url.length <= 40) return url || '';
  return url.slice(0, 37) + '...';
}

function truncateQuery(query) {
  if (!query) return 'Query';
  // Remove extra whitespace
  query = query.replace(/\s+/g, ' ').trim();
  if (query.length <= 30) return query;
  return query.slice(0, 27) + '...';
}

function getDurationClass(duration) {
  if (duration > 100) return 'timeline-item-slow';
  if (duration > 20) return 'timeline-item-medium';
  return 'timeline-item-fast';
}
```
  </action>
  <verify>
```bash
# Check vis-timeline is installed
cd /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener
grep vis-timeline package.json

# Check timeline.js exists with expected exports
head -30 /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/timeline.js
grep -c "export.*function" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/timeline.js
```
vis-timeline in package.json, timeline.js has renderTimeline and destroyTimeline exports.
  </verify>
  <done>
vis-timeline library installed. Timeline module loads vis-timeline dynamically and renders traces as waterfall diagrams with PHP request and SQL query spans.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create detail view module with correlation and comparison</name>
  <files>
    listener/public/detail.js
  </files>
  <action>
Create `listener/public/detail.js`:

```javascript
/**
 * Request Detail View Module
 *
 * Shows detailed view of a request including:
 * - Request metadata
 * - Timeline visualization
 * - Correlated SQL queries
 * - Comparison to historical averages
 */

import { renderTimeline, destroyTimeline } from './timeline.js';

let currentCleanup = null;

/**
 * Show request detail view
 *
 * @param {Object} item - Basic request item from search results
 * @param {HTMLElement} container - Container element for detail view
 */
export async function showRequestDetail(item, container) {
  // Cleanup previous view
  closeDetail();

  // Show loading state
  container.innerHTML = `
    <div class="detail-loading" aria-busy="true">
      Loading request details...
    </div>
  `;

  try {
    // Fetch correlation data and comparison data in parallel
    const [correlationData, comparisonData] = await Promise.all([
      fetchCorrelation(item.correlation_id),
      fetchComparison(item.correlation_id),
    ]);

    // Parse payload if needed
    const payload = typeof item.payload === 'string'
      ? JSON.parse(item.payload)
      : item.payload;

    // Build detail view HTML
    container.innerHTML = `
      <div class="detail-view">
        <div class="detail-header">
          <h3>${escapeHtml(payload.request?.method || 'GET')} ${escapeHtml(payload.request?.uri || 'Unknown')}</h3>
          <button class="close-detail secondary outline" title="Close">&times;</button>
        </div>

        <!-- Comparison Section -->
        <section class="detail-comparison">
          <h4>Performance Comparison</h4>
          ${renderComparison(item, comparisonData)}
        </section>

        <!-- Timeline Section -->
        <section class="detail-timeline">
          <h4>Request Timeline</h4>
          <div id="timeline-container" class="timeline-container"></div>
        </section>

        <!-- SQL Queries Section -->
        <section class="detail-queries">
          <h4>SQL Queries (${correlationData?.summary?.postgres_count || payload.sql?.total_queries || 0})</h4>
          ${renderSqlQueries(correlationData, payload)}
        </section>

        <!-- Request Info Section -->
        <section class="detail-info">
          <h4>Request Information</h4>
          <dl class="detail-grid">
            <dt>Correlation ID</dt>
            <dd><code>${item.correlation_id}</code></dd>
            <dt>Project</dt>
            <dd>${escapeHtml(item.project)}</dd>
            <dt>Duration</dt>
            <dd>${item.duration_ms ? item.duration_ms.toFixed(0) + 'ms' : '-'}</dd>
            <dt>Timestamp</dt>
            <dd>${new Date(item.timestamp * 1000).toLocaleString()}</dd>
            <dt>Status Code</dt>
            <dd>${payload.response?.status_code || '-'}</dd>
            <dt>Server</dt>
            <dd>${escapeHtml(payload.server?.hostname || '-')}</dd>
          </dl>
        </section>

        <!-- Raw Payload Section (collapsed by default) -->
        <details class="detail-raw">
          <summary>Raw Payload</summary>
          <pre><code>${escapeHtml(JSON.stringify(payload, null, 2))}</code></pre>
        </details>
      </div>
    `;

    // Add close button handler
    container.querySelector('.close-detail').addEventListener('click', closeDetail);

    // Render timeline
    const timelineContainer = container.querySelector('#timeline-container');
    if (correlationData) {
      currentCleanup = await renderTimeline(timelineContainer, correlationData);
    } else {
      // Create fake trace data from item payload
      const fakeTrace = {
        trace: {
          php_request: item,
          sql_queries: [],
        },
      };
      currentCleanup = await renderTimeline(timelineContainer, fakeTrace);
    }

  } catch (error) {
    console.error('[Detail] Failed to load request details:', error);
    container.innerHTML = `
      <div class="detail-error">
        <p>Failed to load request details: ${escapeHtml(error.message)}</p>
        <button class="close-detail secondary">Close</button>
      </div>
    `;
    container.querySelector('.close-detail').addEventListener('click', closeDetail);
  }
}

/**
 * Close detail view and cleanup
 */
export function closeDetail() {
  if (currentCleanup) {
    currentCleanup();
    currentCleanup = null;
  }
  destroyTimeline();
}

/**
 * Fetch correlation data from API
 */
async function fetchCorrelation(correlationId) {
  try {
    const response = await fetch(`/api/correlation/${encodeURIComponent(correlationId)}`);
    if (!response.ok) {
      if (response.status === 404) return null;
      throw new Error('Failed to fetch correlation data');
    }
    return await response.json();
  } catch (error) {
    console.warn('[Detail] Could not fetch correlation:', error);
    return null;
  }
}

/**
 * Fetch comparison data from API
 */
async function fetchComparison(correlationId) {
  try {
    const response = await fetch(`/api/compare?correlation_id=${encodeURIComponent(correlationId)}`);
    if (!response.ok) {
      if (response.status === 404) return null;
      throw new Error('Failed to fetch comparison data');
    }
    return await response.json();
  } catch (error) {
    console.warn('[Detail] Could not fetch comparison:', error);
    return null;
  }
}

/**
 * Render comparison section
 */
function renderComparison(item, comparisonData) {
  if (!comparisonData || !comparisonData.comparison) {
    return '<p class="comparison-unavailable">Comparison data not available (need more samples)</p>';
  }

  const { comparison } = comparisonData;
  const percentile = comparison.percentile_rank;
  const avgDuration = comparison.avg_duration;
  const thisDuration = item.duration_ms;

  // Determine performance class
  let perfClass = 'perf-good';
  let perfLabel = 'Faster than average';
  if (percentile > 90) {
    perfClass = 'perf-bad';
    perfLabel = 'Very slow (top 10% slowest)';
  } else if (percentile > 75) {
    perfClass = 'perf-warning';
    perfLabel = 'Slower than average';
  } else if (percentile > 50) {
    perfClass = 'perf-ok';
    perfLabel = 'Around average';
  }

  const diff = thisDuration - avgDuration;
  const diffPercent = avgDuration > 0 ? ((diff / avgDuration) * 100).toFixed(0) : 0;
  const diffSign = diff > 0 ? '+' : '';

  return `
    <div class="comparison-grid">
      <div class="comparison-item">
        <span class="comparison-value">${thisDuration?.toFixed(0) || '-'}ms</span>
        <span class="comparison-label">This Request</span>
      </div>
      <div class="comparison-item">
        <span class="comparison-value">${avgDuration?.toFixed(0) || '-'}ms</span>
        <span class="comparison-label">Average</span>
      </div>
      <div class="comparison-item">
        <span class="comparison-value ${perfClass}">${diffSign}${diff?.toFixed(0) || 0}ms (${diffSign}${diffPercent}%)</span>
        <span class="comparison-label">Difference</span>
      </div>
      <div class="comparison-item">
        <span class="comparison-value">${percentile?.toFixed(0) || '-'}th</span>
        <span class="comparison-label">Percentile</span>
      </div>
    </div>
    <p class="comparison-summary ${perfClass}">${perfLabel} (faster than ${comparison.faster_than_percent?.toFixed(0) || 0}% of ${comparison.sample_size || 0} similar requests)</p>
  `;
}

/**
 * Render SQL queries section
 */
function renderSqlQueries(correlationData, payload) {
  // First try correlation data
  const pgQueries = correlationData?.trace?.sql_queries || [];

  // Fall back to inline SQL from PHP payload
  const inlineQueries = payload?.sql?.queries || [];

  const allQueries = pgQueries.length > 0 ? pgQueries : inlineQueries;

  if (allQueries.length === 0) {
    return '<p>No SQL queries recorded for this request</p>';
  }

  // Limit to 100 queries
  const displayQueries = allQueries.slice(0, 100);
  const hasMore = allQueries.length > 100;

  let html = '<table class="queries-table"><thead><tr><th>#</th><th>Query</th><th>Duration</th></tr></thead><tbody>';

  displayQueries.forEach((q, idx) => {
    // Handle both correlation format and inline format
    let query, duration;
    if (q.payload) {
      const qPayload = typeof q.payload === 'string' ? JSON.parse(q.payload) : q.payload;
      query = qPayload.query || qPayload.data?.query || 'Unknown';
      duration = qPayload.duration_ms || qPayload.data?.duration_ms;
    } else {
      query = q.query || 'Unknown';
      duration = q.duration_ms;
    }

    const durationClass = duration > 100 ? 'duration-slow' : duration > 20 ? 'duration-medium' : 'duration-fast';

    html += `
      <tr>
        <td>${idx + 1}</td>
        <td class="query-cell" title="${escapeHtml(query)}">${escapeHtml(truncateQuery(query, 80))}</td>
        <td class="${durationClass}">${duration?.toFixed(2) || '-'}ms</td>
      </tr>
    `;
  });

  html += '</tbody></table>';

  if (hasMore) {
    html += `<p class="queries-more">${allQueries.length - 100} more queries not shown</p>`;
  }

  return html;
}

// Utility functions

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

function truncateQuery(query, maxLength = 80) {
  if (!query) return '';
  query = query.replace(/\s+/g, ' ').trim();
  if (query.length <= maxLength) return query;
  return query.slice(0, maxLength - 3) + '...';
}
```
  </action>
  <verify>
```bash
head -50 /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/detail.js
grep -c "export.*function" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/detail.js
```
detail.js exists with showRequestDetail and closeDetail exports.
  </verify>
  <done>
Detail view module fetches correlation and comparison data, renders performance comparison, timeline, and SQL queries list. Cleanup function prevents memory leaks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate detail view and update styles</name>
  <files>
    listener/public/app.js
    listener/public/index.html
    listener/public/styles.css
  </files>
  <action>
Modify `listener/public/app.js` to integrate detail view:

1. Add import at the top:
```javascript
import { showRequestDetail, closeDetail } from './detail.js';
```

2. Add detail container to elements cache in init():
```javascript
elements = {
  // ... existing elements ...
  detailPanel: document.getElementById('detail-panel'),
};
```

3. Modify `viewRequestDetails(item)` function to use the new detail module:
```javascript
/**
 * View request details in detail panel
 */
async function viewRequestDetails(item) {
  // Show detail panel
  elements.detailPanel.hidden = false;

  // Render detail view
  await showRequestDetail(item, elements.detailPanel);

  // Scroll to detail panel
  elements.detailPanel.scrollIntoView({ behavior: 'smooth' });
}
```

4. Add function to hide detail panel:
```javascript
/**
 * Hide detail panel
 */
function hideDetailPanel() {
  closeDetail();
  elements.detailPanel.hidden = true;
}
```

5. Add keyboard handler for Escape to close detail:
```javascript
// In init(), add:
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    hideDetailPanel();
    closeModal();
  }
});
```

Modify `listener/public/index.html` to add detail panel:

After the results-section and before the detail-modal, add:
```html
<!-- Detail Panel (shown when viewing a request) -->
<section id="detail-panel" class="detail-panel" hidden>
  <!-- Populated by detail.js -->
</section>
```

Update `listener/public/styles.css` with detail view and timeline styles:

```css
/* Detail Panel */
.detail-panel {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--pico-card-background-color);
  border-radius: var(--pico-border-radius);
  border: 1px solid var(--pico-muted-border-color);
}

.detail-view {
  position: relative;
}

.detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--pico-muted-border-color);
}

.detail-header h3 {
  margin: 0;
  font-size: 1.1rem;
  word-break: break-all;
}

.close-detail {
  padding: 0.25rem 0.75rem;
  font-size: 1.5rem;
  line-height: 1;
}

/* Detail Sections */
.detail-comparison,
.detail-timeline,
.detail-queries,
.detail-info,
.detail-raw {
  margin-bottom: 1.5rem;
}

.detail-comparison h4,
.detail-timeline h4,
.detail-queries h4,
.detail-info h4 {
  margin-bottom: 1rem;
  font-size: 1rem;
  color: var(--pico-muted-color);
}

/* Comparison Grid */
.comparison-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

@media (max-width: 768px) {
  .comparison-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.comparison-item {
  text-align: center;
  padding: 1rem;
  background: var(--pico-background-color);
  border-radius: var(--pico-border-radius);
}

.comparison-value {
  display: block;
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.25rem;
}

.comparison-label {
  font-size: 0.85rem;
  color: var(--pico-muted-color);
}

.comparison-summary {
  text-align: center;
  font-weight: 500;
}

/* Performance classes */
.perf-good {
  color: var(--pico-ins-color);
}

.perf-ok {
  color: var(--pico-primary);
}

.perf-warning {
  color: var(--pico-mark-color);
}

.perf-bad {
  color: var(--pico-del-color);
}

/* Timeline Container */
.timeline-container {
  height: 200px;
  border: 1px solid var(--pico-muted-border-color);
  border-radius: var(--pico-border-radius);
  background: var(--pico-background-color);
}

/* vis-timeline customization */
.timeline-item-php {
  background-color: rgba(54, 162, 235, 0.7);
  border-color: rgb(54, 162, 235);
}

.timeline-item-fast {
  background-color: rgba(75, 192, 192, 0.7);
  border-color: rgb(75, 192, 192);
}

.timeline-item-medium {
  background-color: rgba(255, 206, 86, 0.7);
  border-color: rgb(255, 206, 86);
}

.timeline-item-slow {
  background-color: rgba(255, 99, 132, 0.7);
  border-color: rgb(255, 99, 132);
}

/* Detail Grid */
.detail-grid {
  display: grid;
  grid-template-columns: max-content 1fr;
  gap: 0.5rem 1rem;
  margin: 0;
}

.detail-grid dt {
  font-weight: 500;
  color: var(--pico-muted-color);
}

.detail-grid dd {
  margin: 0;
}

/* Queries Table */
.queries-table {
  font-size: 0.9rem;
}

.queries-table th,
.queries-table td {
  padding: 0.5rem;
}

.query-cell {
  max-width: 500px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-family: monospace;
  font-size: 0.85rem;
}

.queries-more {
  text-align: center;
  color: var(--pico-muted-color);
  font-style: italic;
}

/* Raw Payload */
.detail-raw {
  margin-top: 2rem;
}

.detail-raw pre {
  max-height: 300px;
  overflow: auto;
  font-size: 0.8rem;
}

/* Loading and Error states */
.detail-loading {
  text-align: center;
  padding: 2rem;
}

.detail-error {
  text-align: center;
  padding: 2rem;
  color: var(--pico-del-color);
}

.comparison-unavailable {
  text-align: center;
  color: var(--pico-muted-color);
  font-style: italic;
}
```
  </action>
  <verify>
```bash
# Check app.js has detail import
grep "import.*detail.js" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/app.js

# Check index.html has detail panel
grep "detail-panel" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/index.html

# Check styles.css has detail styles
grep "detail-panel" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/styles.css
grep "timeline-container" /Users/andrewvonhoesslin/public_html/galaxyprojects/bitville-monitoring/listener/public/styles.css
```
All integrations present: import in app.js, detail-panel in HTML, styles for detail view and timeline.
  </verify>
  <done>
Detail view integrated with main app. Timeline visualizes request flow. Comparison shows performance metrics. Styles support timeline, comparison grid, and SQL query list.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Click a request in the results table:
   - Detail panel appears below results
   - Timeline shows PHP request span
   - SQL queries shown if available
   - Comparison metrics displayed

2. Timeline functionality:
   - Can zoom in/out with mouse wheel
   - Can pan left/right by dragging
   - Tooltips show query details on hover

3. Comparison display:
   - Shows this request duration vs average
   - Shows percentile rank
   - Color-coded performance indicator

4. Press Escape or click X to close detail panel

5. No memory leaks:
   - Open/close detail panel multiple times
   - Check browser memory doesn't grow unbounded
</verification>

<success_criteria>
1. Timeline visualization shows PHP request as main span (QUERY-03)
2. Timeline shows SQL queries as child spans within the request
3. PHP request traces are linked to SQL queries via correlation ID (QUERY-04)
4. Comparative analysis shows request vs average (QUERY-05)
5. Percentile rank indicates where this request falls in distribution
6. SQL queries list shows all queries with duration
7. Timeline is interactive (zoom, pan, tooltips)
8. Detail view cleanup prevents memory leaks
</success_criteria>

<output>
After completion, create `.planning/phases/06-query-interface-a-visualization/06-04-SUMMARY.md`
</output>

---
phase: 01-php-agent-core-instrumentation-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /var/www/project/site/profiling/config.php
  - /var/www/project/site/profiling/correlation.php
  - /etc/bitville-apm/profiling.ini
autonomous: true

must_haves:
  truths:
    - "Configuration values are loaded from INI file with safe defaults"
    - "Unique correlation ID is generated for each request"
    - "Config loading has zero overhead after first read (static caching)"
  artifacts:
    - path: "/var/www/project/site/profiling/config.php"
      provides: "Configuration loader with static caching"
      contains: "function get_profiling_config"
    - path: "/var/www/project/site/profiling/correlation.php"
      provides: "UUID v4 correlation ID generator"
      contains: "function generate_correlation_id"
    - path: "/etc/bitville-apm/profiling.ini"
      provides: "Configuration template with all toggleable features"
      contains: "threshold_ms"
  key_links:
    - from: "config.php"
      to: "profiling.ini"
      via: "parse_ini_file with static caching"
      pattern: "parse_ini_file.*profiling\\.ini"
---

<objective>
Create the configuration system and correlation ID generator that all other profiling components depend on.

Purpose: Foundation layer that provides feature toggles, safe defaults, and request correlation capability. Every other profiling component reads config and attaches correlation IDs.

Output:
- `/var/www/project/site/profiling/config.php` - Config loader with static caching
- `/var/www/project/site/profiling/correlation.php` - UUID v4 generator
- `/etc/bitville-apm/profiling.ini` - Configuration template
</objective>

<execution_context>
@/Users/andrewvonhoesslin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrewvonhoesslin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-php-agent-core-instrumentation-safety/01-CONTEXT.md
@.planning/phases/01-php-agent-core-instrumentation-safety/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration loader with static caching</name>
  <files>/var/www/project/site/profiling/config.php, /etc/bitville-apm/profiling.ini</files>
  <action>
Create `/var/www/project/site/profiling/config.php` with:

1. `get_profiling_config()` function that:
   - Uses `static $config = null` for request-level caching (opcache persists between requests)
   - Loads from `/etc/bitville-apm/profiling.ini` using parse_ini_file()
   - Returns safe defaults if file missing or parse fails:
     ```php
     $defaults = [
         'xhprof_enabled' => true,
         'memory_tracking' => true,
         'sql_capture_method' => 'phalcon',  // Options: phalcon, pdo, both, none
         'request_metadata' => true,
         'threshold_ms' => 500,
         'listener_socket' => '/var/run/bitville-apm/listener.sock',
         'project_name' => 'default'
     ];
     ```
   - Logs parse errors to error_log() only (silent to application)
   - Merges parsed config with defaults (parsed values override defaults)

2. Create `/etc/bitville-apm/profiling.ini` template with all options documented:
   ```ini
   ; Bitville APM Profiling Configuration
   ; Changes require PHP-FPM restart to take effect

   [profiling]
   ; Enable XHProf function-level timing (true/false)
   xhprof_enabled = true

   ; Enable memory usage tracking (true/false)
   memory_tracking = true

   ; SQL capture method: phalcon, pdo, both, none
   sql_capture_method = phalcon

   ; Capture request metadata - headers, GET/POST (true/false)
   request_metadata = true

   ; Only send profiling data for requests exceeding this threshold (milliseconds)
   threshold_ms = 500

   [communication]
   ; Unix domain socket path for listener daemon
   listener_socket = /var/run/bitville-apm/listener.sock

   [project]
   ; Project identifier - included in all profiling data
   project_name = myproject
   ```

IMPORTANT:
- Do NOT call file_exists() before parse_ini_file() - parse_ini_file returns false if file doesn't exist
- Use error suppression (@) on parse_ini_file to suppress warnings
- Log failures to error_log() for debugging but return defaults silently
  </action>
  <verify>
Create test script that:
1. Verifies config.php syntax: `php -l /var/www/project/site/profiling/config.php`
2. Calls get_profiling_config() twice, verifies same instance returned
3. Removes INI file temporarily, verifies defaults returned
4. Creates invalid INI file, verifies defaults returned and error logged
  </verify>
  <done>
- Config function returns array with all expected keys
- Static caching works (second call returns cached value)
- Missing/invalid config file returns safe defaults
- No errors thrown, only logged
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UUID v4 correlation ID generator</name>
  <files>/var/www/project/site/profiling/correlation.php</files>
  <action>
Create `/var/www/project/site/profiling/correlation.php` with:

1. `generate_correlation_id()` function that:
   - Returns RFC 4122 compliant UUID v4 string (36 chars with dashes)
   - Uses mt_rand() for PHP 7.4 compatibility (random_bytes available but mt_rand is simpler)
   - Format: `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
     - 4 in position 13 indicates version 4
     - y is 8, 9, a, or b (variant bits)

Implementation from research:
```php
function generate_correlation_id(): string {
    return sprintf(
        '%04x%04x-%04x-%04x-%04x-%04x%04x%04x',
        mt_rand(0, 0xffff), mt_rand(0, 0xffff),                 // 8 hex digits
        mt_rand(0, 0xffff),                                       // 4 hex digits
        mt_rand(0, 0x0fff) | 0x4000,                              // 4 hex digits, version 4
        mt_rand(0, 0x3fff) | 0x8000,                              // 4 hex digits, variant
        mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff) // 12 hex digits
    );
}
```

2. `format_sql_comment($correlationId)` helper function:
   - Returns `/* correlation:{uuid} */ ` (note trailing space)
   - This format is prepended to SQL queries for tracing

IMPORTANT:
- UUID must be lowercase hex
- Total length must be exactly 36 characters
- No external dependencies
  </action>
  <verify>
Create test script that:
1. Verifies syntax: `php -l /var/www/project/site/profiling/correlation.php`
2. Generates 1000 UUIDs, verifies all are 36 chars
3. Verifies version byte (position 14) is always '4'
4. Verifies variant byte (position 19) is 8, 9, a, or b
5. Verifies no duplicates in 1000 generations
  </verify>
  <done>
- generate_correlation_id() returns valid UUID v4 format
- All generated IDs are unique
- format_sql_comment() returns properly formatted SQL comment
- No errors or warnings
  </done>
</task>

<task type="auto">
  <name>Task 3: Create profiling directory structure</name>
  <files>/var/www/project/site/profiling/.gitkeep</files>
  <action>
Create the profiling directory structure that will hold all profiler components:

1. Create directory: `/var/www/project/site/profiling/`
2. Add `.gitkeep` file to ensure directory is tracked
3. Create config directory: `/etc/bitville-apm/` (if it doesn't exist)

Directory structure after this task:
```
/var/www/project/site/profiling/
├── .gitkeep
├── config.php      (from Task 1)
└── correlation.php (from Task 2)

/etc/bitville-apm/
└── profiling.ini   (from Task 1)
```

NOTE: The actual target paths may need adjustment based on where the project repository lives. If running in development environment, create equivalent structure in the working directory.
  </action>
  <verify>
1. Verify directories exist: `ls -la /var/www/project/site/profiling/`
2. Verify config directory exists: `ls -la /etc/bitville-apm/`
3. Verify all files have correct permissions (readable by web server)
  </verify>
  <done>
- Directory structure exists
- All files are in correct locations
- Permissions allow PHP-FPM to read files
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Config loading test:**
```php
<?php
require_once '/var/www/project/site/profiling/config.php';
$config = get_profiling_config();
var_dump($config);
// Should show all config keys with values from INI or defaults
```

2. **Correlation ID test:**
```php
<?php
require_once '/var/www/project/site/profiling/correlation.php';
$id = generate_correlation_id();
echo "ID: $id\n";
echo "Length: " . strlen($id) . "\n";
echo "SQL comment: " . format_sql_comment($id) . "\n";
// ID should be 36 chars, SQL comment should be /* correlation:uuid */
```

3. **Integration test:**
```php
<?php
require_once '/var/www/project/site/profiling/config.php';
require_once '/var/www/project/site/profiling/correlation.php';
$config = get_profiling_config();
$id = generate_correlation_id();
echo "Project: {$config['project_name']}\n";
echo "Threshold: {$config['threshold_ms']}ms\n";
echo "Correlation ID: $id\n";
```
</verification>

<success_criteria>
Requirements covered:
- [x] PHP-02: Generate unique correlation ID (UUID v4) at request start
- [x] PHP-07: Support configurable on/off toggles for each profiling feature via settings file
- [x] PHP-08: Inject project identifier (manual configuration in listener.php) - config provides project_name

Measurable outcomes:
1. get_profiling_config() returns array with all 7 expected keys
2. Config uses static caching (memory address identical on repeated calls)
3. Missing config file returns defaults without errors
4. generate_correlation_id() returns valid UUID v4 (36 chars, version 4, correct variant)
5. 1000 generated IDs have 0 collisions
</success_criteria>

<output>
After completion, create `.planning/phases/01-php-agent-core-instrumentation-safety/01-01-SUMMARY.md`
</output>

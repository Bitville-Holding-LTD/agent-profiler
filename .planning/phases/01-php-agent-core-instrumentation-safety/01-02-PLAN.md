---
phase: 01-php-agent-core-instrumentation-safety
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - /var/www/project/site/profiling/xhprof_collector.php
autonomous: true

must_haves:
  truths:
    - "XHProf profiling can be enabled at request start"
    - "XHProf data can be collected at request end"
    - "Profiling is skipped gracefully if XHProf extension not loaded"
    - "Memory usage is captured with profiling data"
  artifacts:
    - path: "/var/www/project/site/profiling/xhprof_collector.php"
      provides: "XHProf enable/disable/collect functions"
      contains: "function xhprof_start"
      min_lines: 50
  key_links:
    - from: "xhprof_collector.php"
      to: "config.php"
      via: "get_profiling_config() for xhprof_enabled toggle"
      pattern: "get_profiling_config"
---

<objective>
Create the XHProf integration module that handles function-level timing collection with minimal overhead.

Purpose: XHProf provides the detailed function call graph and timing breakdown needed to identify which code paths cause slow requests. This module wraps XHProf in safe functions that handle missing extension gracefully.

Output:
- `/var/www/project/site/profiling/xhprof_collector.php` - XHProf wrapper functions
</objective>

<execution_context>
@/Users/andrewvonhoesslin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrewvonhoesslin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-php-agent-core-instrumentation-safety/01-CONTEXT.md
@.planning/phases/01-php-agent-core-instrumentation-safety/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create XHProf wrapper with safe enable/disable</name>
  <files>/var/www/project/site/profiling/xhprof_collector.php</files>
  <action>
Create `/var/www/project/site/profiling/xhprof_collector.php` with:

1. `xhprof_start()` function:
   - Check if XHProf extension is loaded: `extension_loaded('xhprof')`
   - If not loaded, return false silently (no error)
   - Check config toggle: `get_profiling_config()['xhprof_enabled']`
   - If disabled, return false
   - Enable XHProf with MINIMAL overhead flags:
     ```php
     xhprof_enable(XHPROF_FLAGS_NO_BUILTINS);
     ```
   - IMPORTANT: Do NOT use XHPROF_FLAGS_CPU or XHPROF_FLAGS_MEMORY (200-300% overhead)
   - Return true on success
   - Wrap in try-catch, log errors to error_log, return false

2. `xhprof_stop()` function:
   - Check if XHProf was started (use static flag set in xhprof_start)
   - If not started, return null
   - Call `xhprof_disable()` to stop profiling and get data
   - Return the raw XHProf data array
   - Wrap in try-catch, return null on error

3. `xhprof_format_data($rawData)` function:
   - Takes raw XHProf output and formats for transmission
   - Extract top N slowest functions (configurable, default 100)
   - For each function entry, include:
     - `name`: Function name (e.g., "main()==>load_class")
     - `ct`: Call count
     - `wt`: Wall time in microseconds
   - Sort by wall time descending
   - Return formatted array

4. `get_memory_stats()` function:
   - Check config toggle: `get_profiling_config()['memory_tracking']`
   - If disabled, return empty array
   - Capture:
     ```php
     return [
         'peak_usage' => memory_get_peak_usage(true),  // Real memory
         'current_usage' => memory_get_usage(true),
         'peak_usage_no_real' => memory_get_peak_usage(false),  // Emalloc only
     ];
     ```
   - Return empty array on any error

CRITICAL from research:
- Use XHPROF_FLAGS_NO_BUILTINS ONLY - CPU and memory flags add massive overhead
- XHProf reduces PHP 7 performance to PHP 5.6 levels with full flags
- Memory tracking uses separate PHP functions, not XHProf memory flag

Include at top:
```php
<?php
/**
 * XHProf Collector - Function-level profiling wrapper
 *
 * Requires longxinH/xhprof extension installed
 * Uses XHPROF_FLAGS_NO_BUILTINS only for minimal overhead
 */

require_once __DIR__ . '/config.php';
```
  </action>
  <verify>
1. Syntax check: `php -l /var/www/project/site/profiling/xhprof_collector.php`
2. Test without XHProf extension (mock or skip):
   - xhprof_start() returns false
   - xhprof_stop() returns null
   - No errors thrown
3. If XHProf installed, verify:
   - xhprof_start() returns true
   - xhprof_stop() returns array with function data
   - Data includes 'main()' entry
  </verify>
  <done>
- xhprof_start() safely handles missing extension
- xhprof_stop() returns properly formatted data
- Memory stats captured independently of XHProf
- No exceptions thrown, only logged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add XHProf data filtering and summarization</name>
  <files>/var/www/project/site/profiling/xhprof_collector.php</files>
  <action>
Add to `/var/www/project/site/profiling/xhprof_collector.php`:

1. `xhprof_summarize($rawData, $maxFunctions = 100)` function:
   - Filter out noise (functions with < 1ms total time)
   - Sort by wall time (wt) descending
   - Take top N functions
   - Calculate totals:
     ```php
     $summary = [
         'total_calls' => 0,
         'total_wall_time' => 0,
         'top_functions' => []
     ];
     ```
   - For each top function:
     ```php
     $summary['top_functions'][] = [
         'name' => $functionName,
         'calls' => $entry['ct'],
         'wall_time_us' => $entry['wt'],
         'wall_time_ms' => round($entry['wt'] / 1000, 2),
         'pct_of_total' => round(($entry['wt'] / $totalWt) * 100, 1)
     ];
     ```

2. `xhprof_get_hotspots($rawData, $threshold = 5.0)` function:
   - Return functions consuming more than threshold% of total time
   - These are the "hotspots" worth investigating
   - Format:
     ```php
     return [
         ['name' => 'slow_function', 'pct' => 15.3, 'wall_time_ms' => 234.5],
         ...
     ];
     ```

3. `xhprof_collect_all()` convenience function:
   - Calls xhprof_stop()
   - Calls get_memory_stats()
   - Calls xhprof_summarize()
   - Calls xhprof_get_hotspots()
   - Returns combined result:
     ```php
     return [
         'profiling' => $summary,
         'hotspots' => $hotspots,
         'memory' => $memoryStats,
         'raw_count' => count($rawData)  // Total functions profiled
     ];
     ```
   - Returns null if XHProf wasn't started
  </action>
  <verify>
1. Syntax check: `php -l /var/www/project/site/profiling/xhprof_collector.php`
2. Create test script that:
   - Starts XHProf
   - Runs some test code (loops, function calls)
   - Calls xhprof_collect_all()
   - Verifies result has profiling, hotspots, memory keys
   - Verifies top_functions is sorted by wall time
  </verify>
  <done>
- xhprof_summarize() returns properly filtered/sorted data
- xhprof_get_hotspots() identifies slow functions
- xhprof_collect_all() returns complete profiling package
- Memory stats included in collection
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **XHProf integration test (if extension installed):**
```php
<?php
require_once '/var/www/project/site/profiling/xhprof_collector.php';

// Start profiling
$started = xhprof_start();
echo "XHProf started: " . ($started ? 'yes' : 'no') . "\n";

// Do some work
for ($i = 0; $i < 1000; $i++) {
    $x = str_repeat('x', 100);
}

// Collect data
$data = xhprof_collect_all();
print_r($data);
```

2. **Graceful degradation test (no extension):**
```php
<?php
// Simulate missing extension by checking before require
if (!extension_loaded('xhprof')) {
    require_once '/var/www/project/site/profiling/xhprof_collector.php';
    $started = xhprof_start();
    echo "Started: " . ($started ? 'yes' : 'no') . "\n";  // Should be 'no'
    $data = xhprof_collect_all();
    echo "Data: " . ($data === null ? 'null (correct)' : 'unexpected data') . "\n";
}
```

3. **Memory tracking test:**
```php
<?php
require_once '/var/www/project/site/profiling/xhprof_collector.php';
$memBefore = get_memory_stats();
$bigArray = range(1, 100000);
$memAfter = get_memory_stats();
echo "Memory before: " . ($memBefore['peak_usage'] / 1024 / 1024) . " MB\n";
echo "Memory after: " . ($memAfter['peak_usage'] / 1024 / 1024) . " MB\n";
```
</verification>

<success_criteria>
Requirements covered:
- [x] PHP-03: Integrate XHProf for function-level timing breakdown
- [x] PHP-05: Collect memory usage per function (peak memory, allocations)

Measurable outcomes:
1. xhprof_start() returns true when extension loaded and config enabled
2. xhprof_start() returns false (no error) when extension missing
3. xhprof_collect_all() returns array with profiling, hotspots, memory keys
4. Top functions sorted by wall time descending
5. Memory stats include peak_usage, current_usage values
6. No errors thrown under any condition
</success_criteria>

<output>
After completion, create `.planning/phases/01-php-agent-core-instrumentation-safety/01-02-SUMMARY.md`
</output>
